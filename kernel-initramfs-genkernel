#!/bin/sh
#2.0.0
#2018-11-11

#Copyright (C) 2018 Brandon Zorn, brandonzorn@cock.li
#
#This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <https://www.gnu.org/licenses/>.

if [ "$(id -u)" -ne 0 ];then printf "Requires root, exiting.\n";return;fi
if ! [ -f "/usr/src/linux/usr/gen_init_cpio" ];then printf "Make sure the kernel is build first\n";exit;fi

logfile="/dev/null"
comp="lz4"
loglevel="1"

hlp(){
	printf "GENERAL\n"
	printf " -h\tprint this help\n"
	printf " -L #\tset loglevel 1-5 [default : 1]\n"
	printf " -v\tlog to /tmp/genkernel-initgen.log\n"
	printf "\nCOMPRESSION\n"
	printf " -l\tcompress initramfs using : lz4 [default]\n"
	printf " -x\tcompress initramfs using : xz \n"
}

while true;do
	case "${1}" in
		-v) logfile="/tmp/genkernel-initgen.log";shift;;
		-l) comp="lz4";shift;;
		-x) comp="xz";export XZ_OPT="-9e";shift;;
		-L)
			if [ -n "${2}" ] && [ ${2} -ge "1" ] && [ "${2}" -le "5"  ] ;then
				loglevel="${2}"
			else
				printf "loglevel not within bounds, using default value\n"
			fi
			shift;shift;;
		-h) hlp;return;;
		*) break;;
	esac
done

genkernel initramfs \
	--logfile=${logfile} \
	--install \
	--makeopts=-j$(($(nproc)+1)) \
	--loglevel=${loglevel} \
	--no-ramdisk-modules \
	--busybox \
	--compress-initramfs \
	--compress-initramfs-type=${comp} \
	--no-clean \
	--no-mountboot \
	--no-keymap \
	--no-lvm \
	--no-mdadm \
	--no-nfs \
	--no-dmraid \
	--no-btrfs \
	--no-multipath \
	--no-iscsi \
	--no-hyperv \
	--no-ssh \
	--no-luks \
	--no-gpg \
	--no-unionfs \
	--no-netboot \
	--no-e2fsprogs \
	--no-dmraid \
	--postclear \
	--no-splash \
	--disklabel \
	--strip=all \
	--zfs \
	--microcode \
	--firmware \
	--firmware-dir=/lib/firmware
