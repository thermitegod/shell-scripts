#!/bin/sh
#5.7.0
#2018-12-30

#Copyright (C) 2018 Brandon Zorn, brandonzorn@cock.li
#
#This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <https://www.gnu.org/licenses/>.

#misc
#lxc will not mount on symlinks, but can mount through them

hlp(){
	printf "\nCONTAINER, only use to limit actions to specified\n"
	printf " -T\tOnly run on transmission, uses :${transmission_port} as port\n"
	printf " -R\tOnly run on rutorrent\n"
	printf "\nCONTAINER GENERAL\n"
	printf " -d\tDelete containers\n"
	printf " -D\tDelete 'old-*' containers\n"
	printf " -h\tPrint this help\n"
	printf " -r\tRestart\n"
	printf " -s\tStart\n"
	printf " -u\tUpdate, rename existing with 'old-*' prefix\n"
	printf " -z\tStop\n"
	printf " -Z\tForce stop\n"
	printf "\nSPECIFIC, no other flags req\n"
	printf " -c\trtorrent lockfile cleanup\n"
	printf " -C\trutorrent cleanup only, remove *.torrent files in \$config/rutorrent/share/torrents/\n"
	printf "\nOTHER\n"
	printf " -e\tedit ${container_info}\n"
	printf " -p\tPrint limited container vars\n"
	printf " -P\tPrint all container vars\n"
}

set_dirs(){
	#not in container
	storage="/mnt/torrents"
	config="${storage}/.config/${cname}"
	session="${config}/session"
	watch="${config}/watch"
	save="${storage}/${cname}"
	if [ -n "${save_override}" ];then save="${save_override}";fi
	#in container
	case "${ctype}" in
		rutorrent)
			case "${distro}" in
				alpine) var="/usr/share/webapps/rutorrent/share";;
				gentoo) var="/var/www/localhost/htdocs/rutorrent/share";;
			esac
			rushare="${config}/rutorrent/share"
			setbase="/home/brandon"
			inside_data="${setbase}/rtorrent/data"
			inside_watch="${setbase}/rtorrent/watch"
			inside_session="${setbase}/rtorrent/session"
			;;
		transmission)
			setbase="/var/lib/transmission"
			inside_data="${setbase}/downloads"
			inside_session="${setbase}/config"
			;;
	esac

	if [ "${get_dirs}" = "1" ];then return;fi

	if ! [ -e "${config}" ];then mkdir -pv "${config}"; fi
	if ! [ -e "${save}" ];then mkdir -pv "${save}"; fi
	if ! [ -e "${session}" ];then mkdir -pv "${session}"; fi
	if ! [ -e "${watch}" ] && [ "${ctype}" = "rutorrent" ];then mkdir -pv "${watch}";fi
	if ! [ -e "${rushare}" ] && [ "${ctype}" = "rutorrent" ];then mkdir -pv "${rushare}";fi

	lxc config device add "${fullname}" storage disk source="${save}" path="${inside_data}"
	lxc config device add "${fullname}" session disk source="${session}" path="${inside_session}"
	if [ "${ctype}" = "rutorrent" ];then
		lxc config device add "${fullname}" watch disk source="${watch}" path="${inside_watch}"
		lxc config device add "${fullname}" ru disk source="${rushare}" path="${var}"
	fi
}

set_ip(){
	printf "Seting StaticIP to 192.168.0.${ip4}\n"
	tmp=$(mktemp)
	case "${distro}" in
		alpine)
			net="${fullname}/etc/network/interfaces"
			printf "auto eth0\niface eth0 inet static\n\taddress 192.168.0.${ip4}\n\tnetmask 255.255.255.0\n\tgateway 192.168.0.1\n">|"${tmp}"
			;;
		gentoo)
			net="${fullname}/etc/conf.d/net"
			printf "rc_keyword=\"-stop\"\nconfig_eth0=\"192.168.0.${ip4} netmask 255.255.255.0 brd 192.168.0.255\"\nroutes_eth0=\"default via 192.168.0.1\"\n">|"${tmp}"
			;;
	esac
	lxc file push "${tmp}" "${net}"
	if [ -f "${tmp}" ];then rm "${tmp}";fi
}

set_limits(){
	if ! [ "${lim_cpu}" = "0" ];then lxc config set "${fullname}" limits.cpu "${lim_cpu}";fi
	if ! [ "${lim_cpu_allow}" = "0" ];then lxc config set "${fullname}" limits.cpu.allowance "${lim_cpu_allow}";fi
	#if ! [ "${lim_cpu_priority}" = "0" ];then lxc config set "${fullname}" limits.cpu.priority "${lim_cpu_priority}";fi
	if ! [ "${lim_mem}" = "0" ];then lxc config set "${fullname}" limits.memory "${lim_mem}";fi
}

remove_devices(){
	#remove unneeded access to filesystem
	lxc config device remove "${fullname}" distfiles
	lxc config device remove "${fullname}" packages
	lxc config device remove "${fullname}" repos
}

rtorrent_clean_lock(){
	get_dirs="1"
	set_dirs
	lock="${session}/rtorrent.lock"
	if [ -f "${lock}" ];then rm -v "${lock}";fi
	get_dirs="0"
}

main_container(){
	if [ -n "$(echo ${ctype}|grep '\#')" ];then return;fi #skip comments
	if [ -n "$(echo ${ctype}|grep 'stop')" ];then exit;fi #exit when 'stop' is read, will be changed
	case "${distro}" in
		alpine) true;;
		gentoo) true;;
		*) printf "skipping non supported distro : ${distro}\n";return;;
	esac
	template="base-${distro}-${ctype}"
	fullname="${ctype}-${cname}"
	if [ "${limit}" = "1" ] && ! [ "${limit_to}" = "${ctype}" ];then return;fi
	case "${act}" in
		stop) printf "Stopping container: ${fullname}\n";lxc stop "${fullname}" &;;
		start) printf "Starting container: ${fullname}\n";sleep 1;lxc start "${fullname}" &;;
		delete) printf "Deleteing container: ${fullname}\n";lxc delete "${fullname}" &;;
		restart) printf "Restarting container: ${fullname}\n";lxc restart "${fullname}" &;;
		deleteold) printf "Deleting container: old-${fullname}\n";lxc delete "old-${fullname}" &;;
		forcestop) printf "Force stopping container: ${fullname}\n";lxc stop --force "${fullname}" &;;
		rt_cleanup_lock) rtorrent_clean_lock;;
		ru_cleanup)
			get_dirs="1"
			set_dirs
			#if [ $(find ${rushare}/share/torrents -type f -quit) ];then echo n;return;fi
			rm ${rushare}/torrents/*.torrent
			get_dirs="0"
			;;
		update)
			printf "Update running for : ${fullname}\n"

			if [ "$(echo ${lxclist}|grep ${fullname})" ];then
				printf "Renaming ${fullname} to old-${fullname}\n"
				lxc rename "${fullname}" "old-${fullname}"
			fi

			printf "Copying ${template} to ${fullname}\n"
			lxc copy "${template}" "${fullname}"

			if [ "${distro}" = "gentoo" ];then remove_devices;fi
			set_limits
			set_dirs
			set_ip
			rtorrent_clean_lock
			printf "\n"
			;;
		print)
			printf "Container Name\t: ${fullname}\n"
			printf "Name\t\t: ${cname}\n"
			printf "Template\t: ${ctype}\n"
			printf "Distro\t\t: ${distro}\n"
			if [ "${ctype}" = "transmission" ];then ip4="${ip4}:${transmission_port}";fi
			printf "IPV4\t\t: 192.168.0.${ip4}\n"
			if [ "${verbose}" = "1" ];then
				printf "Limit CPU\t: ${lim_cpu}\n"
				printf "Limit CPU ALLOW\t: %s\n" "${lim_cpu_allow}"
				printf "Limit MEM\t: ${lim_mem}\n"
				set_dirs
				printf "session\t\t: ${session}\n"
				if [ "${ctype}" = "rutorrent" ];then
					printf "rushare\t\t: ${rushare}\n"
					printf "watch\t\t: ${watch}\n"
				fi
				printf "save\t\t: ${save}\n"
				if [ -n "${save_override}" ];then printf "save override\t: active\n";fi
			fi
			printf "\n"
			;;
	esac
}

limit="0"
verbose="0"
get_dirs="0"
printonly="0"

limit_to="z"
transmission_port="9091"
. $(dirname "$0")/utils.sh
container_info="${extra}/lxd-admin"
lxclist=$(lxc list)

if [ -z "${1}" ];then hlp;exit;fi
while getopts "TRCDPZcdrsuzphe" OPT;do
	case "${OPT}" in
		T) limit="1";limit_to="transmission";;
		R) limit="1";limit_to="rutorrent";;
		c) act="rt_cleanup_lock";limit_to="rutorrent";;
		C) act="ru_cleanup";limit_to="rutorrent";;
		d) act="delete";;
		D) act="deleteold";;
		r) act="restart";;
		s) act="start";;
		u) act="update";;
		z) act="stop";;
		Z) act="forcestop";;
		p) act="print";;
		P) act="print";get_dirs="1";verbose="1";;
		h) hlp;exit;;
		e) $EDITOR "${container_info}";exit;;
	esac
done

if ! [ -f "${container_info}" ];then
	printf "all containers are declared in '${container_info}' using the following space delimited format, subject to change\n"
	printf "'container type' 'distro' 'IPV4 ending' 'limit cpu' 'limit cpu allowance' 'limit mem' 'container name' 'save location override, optional'\n"
	printf "NOTE: to not use limits, set them to '0'\n"
	printf "example: rutorrent gentoo 161 6 10%% 8192MB anime /mnt/anime/anime-working\n"
	exit 1
fi

while IFS=' ' read -r ctype distro ip4 lim_cpu lim_cpu_allow lim_mem cname save_override;do
	main_container
done < "${container_info}"

